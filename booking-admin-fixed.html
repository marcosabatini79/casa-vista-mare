<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† Pannello Admin - Gestione Prenotazioni</title>
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=yF-UToWr03q0EKtTWtbGxNvo45jTLtra6Fva-OWk89QBZQiBfmEF6MBVVCW5Z_fxEWEdVpNdiHiG2PluhQCoXWjfOXcR5zDV5BxkeCS0NWd_81MQGy969SGswxb9_9Ybvvin1vuXeDMEGx4vzdXgHDH1_Xme1DmyQ7NeAB7GpdLZqESkBc5l4r8TgE41PHG72Z6G_pfc4YbWqJhS97qVX8xAsjaaMrqWM4ZFqcazIyom7vzLvLQl1M3wiivE55GT01R-b6qX7oXSE-jTFj5WRSGTV-Z4YLXi9vb4DZKE-JPnGug89b2zVQlNaLBAMBfHzoiK3o8rjumokZUSgx6Rr2bMmZVu8iFr3uYReKoVDwKd9seDbkBjz5xOmnUAgO0OHytdfLh-xwe6rDZzGG7Vj4k_Isl6yV2DpHjCkMYjw9YQ5P8NhmUqc37okrPHzS0P7FjJCHYR99WUeP3Cwp-p04gomcRfibcEjgQkQDjNDG0xadIBioi6jF0tf9Wa0OW36qmVrxHnkY2SNNdKik0M38Xuuc48xltpo3Fo0v7ivRaXcRv6uNOjtfkxrys5GgjYu5eWgUfCXWVf57YsiKK1Bw72Mr_0r9y4If_aFq41Cqrbb5Vo9USDMamNVg32eqszQ1psnr5xy39CkxZH_45hF7V6ytPEtG3Xqs08Qcl4p33dOM29fv5o4-vZcS14YvYcMwJmSiDGDg0LrLful3FtkfTGIlVo-5pphWXUomTZT751oB9uZ7Oc1G39JtWMia27gf2hQkjldHFzZYX-8s-M3s64ntDFqeKlHEUIpvmwg2OTk4Nl_8HytxDUrR5qpRyCVrBLPiguHCMom1A9CV0kl1tsIag_lWg1vXmKkOA-D0xQYM6k4MxM4GbEEuEfb_y_wh1JKJDEETqTkLSJaTyD_m5jaEZ8uq8gMvRPza7-5y4MLBXbCagFohzIHqP6VyMo4yx_Ns6U9p-sgZ-UakydJqOdxyEmseD59bZkJRgb0gOoQoOyUOkV7_sBrI0NnDeEnMQ5nQEqMFts9HA-iUeGiEcvn36y6ppldLw-PhHAlfHpScSMA3rAeLekUK0tHIf_MQPrF7ljwi2r8n4tPNC3905CQecf0CxUBSRoBY-kdFIYM_abGOGk0iS-dhYQsnifKQ83_ApLOgLO55DWASAFy4Cx1GuHfGUnEYsa0wbwy44-yxwswrrfXe4d9oQVHPkU-F__eS_YG5XGUdDtVtv-5dR99tM9nf-WsUKjShZoHWuUWMV0taGPGNX3RZxmuC50cskJqeWjPFXtwcqIp8FJBdSwOSooJpcQDqLz9VVwnzVLMu13bKf6vjcnxCdulVpLEj-Vy0PnpZmoQjpNY00Iri1zf6Qz6IQ9BVJQmmEV9pQzqPRPtEqH-UsUXu8y1BiHtQJweaEI5P-FLLHC7Dm0gC_SbwAMs7CaaFbmqReopyfxWtyyE8dsLy8Mo0WK4A7tOuDRoDotQbeNcrg9LtrJ775gO_3qG2DOCnlT0MOiZDxPO3ZzlsWb-_zdqXq0gpweOUiRGxMEhuNKcKJ4GQ-x4I7plMgdN9iy8w-1hOBbQbgRe9dOnuYo4Ynlzg8EfDJY0_WEGqgbUpqmDqsFnjTl3IsQG0T9dTxtBbUc_J-0L2GQkCKrAMerOQk-faTObBrIkCTp3DWqETHzusD0NBFC0YV-w8rynN9QSby4es6WbnTuYL5NMExxYzNan2_gqLb8TygjTnCl-qiGskcR6JxxR81lxOXBSPX0v1L_OwwSh2_5_Nw6T45trW-w8idIG_Z6fRPKc5fnkasyVsDaLMis2bjmLfWRSrQ-UkNwDgjIjd5UafVAuGVbmB-LCRl9H-ex1E7osN8149LOBvMdHmb205jh5CCo6RtQXZq0dCAD9m8re0xeclzwl_EuGAGQ-8IkWP0z3GXhID1qsxyWn6bb2BMbbXdxx875U7BzGEytkKlk3mIj502V4P_pNed18kXVx4YI6fKwso6_pr-HK0nIY2RKLwthBBJH8kucZ9YLHv-zMYXSAgAnY2LVmTZI7kjpxmCjr0tgoz0pa4kZOVsh3KW6eN4qCOLJCtAk1fn7cct_WP8ZWP5Tq-oOFe0Bti0VkdlvKu7otUnAQuSWuEZiArNovP5aUrQ-89jZnV53tJDGrcbbk-JDOSt4vInC7vGBxLFc-EJf2_bvTQwMrm5QN-tSCI-y6PnLNejIflEB3dcqpcp9rGxg5AerZO2VHAP2QNzC_gn8kfsEYJUzbJ4VwOruPnwdY4uHlHBG5g0UI-Y" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="https://gc.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9wcGwtYWktY29kZS1pbnRlcnByZXRlci1maWxlcy5zMy5hbWF6b25hd3MuY29tL3dlYi9kaXJlY3QtZmlsZXMvMWJlN2NiYTI3MmE3MjgxMDJhNjc1NmI3ZGQzMzhmYTYvZTQxZmVkNTAtMTE3Yi00OWJjLTlhN2YtOGMwZDIwYWY2OTIyLzVhMWFhOTU0Lmh0bWw_cmVzcG9uc2UtY29udGVudC1kaXNwb3NpdGlvbj1hdHRhY2htZW50JTNiJTIwZmlsZW5hbWUlM2Rib29raW5nLWFkbWluLWZpeGVkLmh0bWwlM2IlMjBmaWxlbmFtZSUyYSUzZFVURi04JTI3JTI3Ym9va2luZy1hZG1pbi1maXhlZC5odG1sJkFXU0FjY2Vzc0tleUlkPUFTSUEyRjNFTUVZRVpUNzQzVDRWJlNpZ25hdHVyZT1TOG5Gelkyc09ZRXNJMVB2ZzFFdnJpQWVUeUElM2QmeC1hbXotc2VjdXJpdHktdG9rZW49SVFvSmIzSnBaMmx1WDJWakVNJTJmJTJmJTJmJTJmJTJmJTJmJTJmJTJmJTJmJTJmJTJmd0VhQ1hWekxXVmhjM1F0TVNKSU1FWUNJUUNJTFNPZEhZU09yYnglMmJsY0xUcDlpJTJiVzBNOVF1cjJ3SEZHYmZmRHBYV1dDQUloQUxUd0VVWW9ybWtjdHYyQUFLb1Y1c2hOUWlsYWFtUjIxTmslMmZtOXc0dEdUOEt2RUVDSGdRQVJvTU5qazVOelV6TXpBNU56QTFJZ3l1OGRvZmpDVjlRa1J1RE5NcXpnU1FGYklvdk5LMnVuV1U1YXZPQ3Bjc1dpakRTbjlqRFRVYWgwYUx5RXZjNDdVTUNEMlJDYnAlMmY3VmY0cldaWG5QJTJiMzJGTyUyYjZ5MlNoNG15bVZncXhRa1YwaXVnWVc0aFRIMDNiUUVUS0o2Um5rNmQ0Yzg4Y01jaTBZcmZpSnQlMmZzMU9RdlVrMGoyWndOR08lMmYxMDdjTFZHRkFSWWJRTkFmQW41RzgxcUhHT2tpWjNWR05tck0lMmJ0QU1vVzEyRzl3c0FMa3o4MXZ5ZkRaT2pCTmJwZ2o1d2dpTUNna2NDeDhySElBTHVjczBjbVhPVlZBMUpiazdVNllGTE5SU0daJTJiYVY2TkslMmZLbXN4ZnRWdFZ3aUVWdm12STJHcEVoS2luNGMyYTlLN1JNWXBiOU1VdENkUjNEd3lFQ1EyZVhFSkVoNSUyYlYlMmJMc3ByYzlZJTJmU283R0dGU2xMZ2pIbnNxMkc0bHNaRHVZVXI3TkMzQ1dBQjYxNHVzTXlVWkhiSktmcjgwaExJSnpodXhWS3BEUWxUQXM5V21CaUJXY2RXcTVFRkQ2bzcxZTJDJTJiZG5zWGtxS0pxZ3ZmUjlmYmRuaFloaGg5Wmo5UTlpUnFOZTlkTDFFTnpOUDdaQWVRZWtqJTJiOElDQ05FdXZ1dE53MjM4SUVpREdCQUVyUFVmNFpXJTJmd0FxMXBZMndIR3dabTY3Ump4MVlyNnZMZXp2U1lXaUJxdDR0TWViOUxxM3hpWlRUdHU0ZWplZ3BBdU1HWlp6JTJiYTRqd1FmbEtKWkZRNHMlMmJpSTlSUGZjUFVnelptMVEzeENyQ0ZrVCUyYmthODRKZDZxaGFmazg0azAxeXp5JTJiWDNQM25TSjhWTWxLdm9vVlhVaDRBdW1PVUdzV0tUNGloMnhoOVo2ZkJyWUNBcko4WTFYT0t4dDVnVzRIU3RVYU5OeEFUNk1YSWNLb0QzQUNrSzJIWHNsWGVnY0lrWXJxWlFnQldRaHliNkI3SzBOdjE0aFlhbFBKbWxmWWI1cFFJMXFEUjNlejRGQUFDQmRVSnU0bm1BZkExNE0lMmZHbFRZVERXNmI3SEJqcVpBZHdQRWRRYVQyRjdCZW8ydldxJTJiMHdpMVBPeWRYNGhxazZHbGhXNERpMXJ4WFZacVB0d0glMmI3QnIyM1BaTVo5WVAlMmJoSEkzR2NLNzRlbFBwenJvV3hUcUpWakdvTnlzWVZleENYbEQlMmY2V0l0NmZlcG84Q2xYTW4yM2FZSXFRSEslMmZLM2VubjRMdTRTNDdZemhhZDRZYlg1WjU1VjhGUFVmMzZ5cGtpWERoZ1h3MHpKb000Z1lWQWMlMmZlTVFzeTdLWlF6aTkzblRFeDA5dHFFdyUzZCUzZCZFeHBpcmVzPTE3NjA1NDEyNjE"/><style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #3498db;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .stat-card.ical h3 {
            color: #e74c3c;
        }
        
        .stat-card.bookings h3 {
            color: #2ecc71;
        }
        
        .ical-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .ical-section h3 {
            color: white;
            margin-bottom: 20px;
        }
        
        .ical-section .form-group input {
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background-color: #2ecc71; }
        .status-disconnected { background-color: #e74c3c; }
        .status-loading { 
            background-color: #f39c12; 
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .error-message {
            background-color: rgba(231,76,60,0.1);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .price-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .price-item input {
            width: 80px;
            text-align: right;
        }
        
        .bookings-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .booking-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #2ecc71;
        }
        
        .booking-item h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .booking-item p {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 3px;
        }
        
        .dates-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .date-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            position: relative;
        }
        
        .date-item.ical {
            border-left-color: #e74c3c;
        }
        
        .date-item .source {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }

        .proxy-options {
            margin-top: 15px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .proxy-options select {
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 12px;
            padding: 5px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Pannello Admin - Gestione Prenotazioni</h1>
            <p>Gestisci calendari, prezzi e prenotazioni</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3 id="total-occupied">0</h3>
                <p>Date Occupate Totali</p>
            </div>
            <div class="stat-card ical">
                <h3 id="ical-count">0</h3>
                <p>Da Calendario iCal</p>
            </div>
            <div class="stat-card bookings">
                <h3 id="bookings-count">0</h3>
                <p>Prenotazioni Ricevute</p>
            </div>
        </div>
        
        <!-- Sezione iCal -->
        <div class="ical-section">
            <h3>üîó Sincronizzazione Calendario iCal</h3>
            <div class="form-group">
                <label for="ical-url">URL del calendario iCal (.ics):</label>
                <input type="url" id="ical-url" placeholder="https://calendar.google.com/calendar/ical/esempio.ics">
            </div>
            <button class="btn" onclick="loadICalData()">Carica Calendario</button>
            <button class="btn btn-success" onclick="syncICalData()">Sincronizza Automaticamente</button>
            <button class="btn" onclick="clearICalData()">Rimuovi Sync</button>
            
            <div class="proxy-options">
                <label>Proxy CORS:</label>
                <select id="cors-proxy">
                    <option value="https://api.allorigins.win/raw?url=">allorigins.win (default)</option>
                    <option value="https://corsproxy.io/?">corsproxy.io</option>
                    <option value="https://cors-anywhere.herokuapp.com/">cors-anywhere.herokuapp.com</option>
                    <option value="">Nessun proxy (solo se il server supporta CORS)</option>
                </select>
            </div>
            
            <div style="margin-top: 15px;">
                <span class="status-indicator" id="ical-status"></span>
                <span id="ical-status-text" style="color: white;">Non connesso</span>
            </div>
            
            <div class="error-message" id="ical-error"></div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h2>üìÖ Gestione Date Manuali</h2>
                <div class="form-group">
                    <label for="manual-date">Aggiungi Data Occupata:</label>
                    <input type="date" id="manual-date">
                </div>
                <div class="form-group">
                    <label for="manual-description">Descrizione (opzionale):</label>
                    <input type="text" id="manual-description" placeholder="Es: Prenotazione diretta">
                </div>
                <button class="btn btn-success" onclick="addManualDate()">Aggiungi Data</button>
                <button class="btn btn-danger" onclick="clearAllManualDates()">Cancella Tutte</button>
            </div>
            
            <div class="card">
                <h2>üí∞ Gestione Prezzi</h2>
                <div class="pricing-grid">
                    <div class="price-item">
                        <h4>üå∏ Bassa Stagione</h4>
                        <div class="form-group">
                            <input type="number" id="price-low" value="80" min="0">
                            <span>‚Ç¨/notte</span>
                        </div>
                    </div>
                    <div class="price-item">
                        <h4>‚òÄÔ∏è Media Stagione</h4>
                        <div class="form-group">
                            <input type="number" id="price-medium" value="120" min="0">
                            <span>‚Ç¨/notte</span>
                        </div>
                    </div>
                    <div class="price-item">
                        <h4>üèñÔ∏è Alta Stagione</h4>
                        <div class="form-group">
                            <input type="number" id="price-high" value="180" min="0">
                            <span>‚Ç¨/notte</span>
                        </div>
                    </div>
                    <div class="price-item">
                        <h4>üéÑ Festivit√†</h4>
                        <div class="form-group">
                            <input type="number" id="price-holiday" value="150" min="0">
                            <span>‚Ç¨/notte</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="savePricing()">Salva Prezzi</button>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h2>üìã Prenotazioni Ricevute</h2>
                <div class="bookings-list" id="bookings-list">
                    <p>Nessuna prenotazione ricevuta</p>
                </div>
                <button class="btn" onclick="exportBookings()">Esporta Prenotazioni</button>
                <button class="btn btn-danger" onclick="clearAllBookings()">Cancella Tutte</button>
            </div>
            
            <div class="card">
                <h2>üóìÔ∏è Date Occupate</h2>
                <div class="dates-container" id="dates-container">
                    <p>Nessuna data occupata</p>
                </div>
                <button class="btn" onclick="exportDates()">Esporta Date</button>
            </div>
        </div>
        
        <div class="card full-width">
            <h2>‚öôÔ∏è Azioni di Sistema</h2>
            <button class="btn" onclick="exportAllData()">üìÑ Esporta Tutti i Dati</button>
            <button class="btn" onclick="importData()">üìÇ Importa Dati</button>
            <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleImport()">
            <button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è Reset Completo</button>
        </div>
    </div>

    <script>
        let occupiedDates = [];
        let icalDates = [];
        let manualDates = [];
        let bookings = [];
        let icalSyncInterval = null;
        
        // Caricamento iniziale
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            updateStats();
            updateDisplays();
        });
        
        function loadAllData() {
            // Carica date manuali
            const savedManualDates = localStorage.getItem('adminManualDates');
            if (savedManualDates) {
                manualDates = JSON.parse(savedManualDates);
            }
            
            // Carica date iCal
            const savedIcalDates = localStorage.getItem('adminIcalDates');
            if (savedIcalDates) {
                icalDates = JSON.parse(savedIcalDates);
            }
            
            // Carica prenotazioni
            const savedBookings = localStorage.getItem('adminBookings');
            if (savedBookings) {
                bookings = JSON.parse(savedBookings);
            }
            
            // Carica URL iCal
            const savedIcalUrl = localStorage.getItem('icalUrl');
            if (savedIcalUrl) {
                document.getElementById('ical-url').value = savedIcalUrl;
            }
            
            // Carica proxy preference
            const savedProxy = localStorage.getItem('corsProxy');
            if (savedProxy) {
                document.getElementById('cors-proxy').value = savedProxy;
            }
            
            // Carica prezzi
            loadPricing();
            
            // Aggiorna array combinato
            updateCombinedDates();
        }
        
        function updateCombinedDates() {
            occupiedDates = [...manualDates, ...icalDates];
            // Salva per il frontend
            localStorage.setItem('adminOccupiedDates', JSON.stringify(occupiedDates));
        }
        
        function loadPricing() {
            const savedPricing = localStorage.getItem('adminPricing');
            if (savedPricing) {
                const pricing = JSON.parse(savedPricing);
                document.getElementById('price-low').value = pricing.low.price;
                document.getElementById('price-medium').value = pricing.medium.price;
                document.getElementById('price-high').value = pricing.high.price;
                document.getElementById('price-holiday').value = pricing.holiday.price;
            }
        }
        
        function savePricing() {
            const pricing = {
                low: { 
                    price: parseInt(document.getElementById('price-low').value),
                    name: 'üå∏ Bassa Stagione', 
                    description: 'Gennaio-Marzo, Novembre-Dicembre' 
                },
                medium: { 
                    price: parseInt(document.getElementById('price-medium').value),
                    name: '‚òÄÔ∏è Media Stagione', 
                    description: 'Aprile-Maggio, Settembre-Ottobre' 
                },
                high: { 
                    price: parseInt(document.getElementById('price-high').value),
                    name: 'üèñÔ∏è Alta Stagione', 
                    description: 'Giugno-Agosto' 
                },
                holiday: { 
                    price: parseInt(document.getElementById('price-holiday').value),
                    name: 'üéÑ Festivit√†', 
                    description: 'Natale, Capodanno, Pasqua' 
                }
            };
            
            localStorage.setItem('adminPricing', JSON.stringify(pricing));
            alert('Prezzi salvati con successo!');
        }
        
        // Gestione iCal con proxy multipli
        function parseICS(icsString) {
            const lines = icsString.split(/\r?\n/);
            const events = [];
            let event = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line === 'BEGIN:VEVENT') {
                    event = {};
                } else if (line === 'END:VEVENT' && event) {
                    if (event.DTSTART) {
                        const startDate = parseICalDate(event.DTSTART);
                        let endDate = startDate;
                        
                        if (event.DTEND) {
                            endDate = parseICalDate(event.DTEND);
                        }
                        
                        let currentDate = new Date(startDate);
                        const finalDate = new Date(endDate);
                        
                        while (currentDate <= finalDate) {
                            events.push(currentDate.toISOString().split('T')[0]);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                    event = null;
                } else if (event) {
                    const match = /^([A-Z-]+[A-Z])[:;](.*)$/.exec(line);
                    if (match) {
                        const [, key, value] = match;
                        // Rimuovi parametri dalle chiavi (es: DTSTART;VALUE=DATE -> DTSTART)
                        const cleanKey = key.split(';')[0];
                        event[cleanKey] = value;
                    }
                }
            }
            
            return events;
        }
        
        function parseICalDate(icalStr) {
            // Rimuovi parametri VALUE=DATE se presenti
            const dateStr = icalStr.includes(':') ? icalStr.split(':')[1] : icalStr;
            
            if (dateStr.includes('T')) {
                // Data con orario: YYYYMMDDTHHMMSS
                const year = dateStr.substr(0, 4);
                const month = dateStr.substr(4, 2);
                const day = dateStr.substr(6, 2);
                return new Date(year, parseInt(month) - 1, day);
            } else {
                // Solo data: YYYYMMDD
                const year = dateStr.substr(0, 4);
                const month = dateStr.substr(4, 2);
                const day = dateStr.substr(6, 2);
                return new Date(year, parseInt(month) - 1, day);
            }
        }
        
        async function loadICalData() {
            const url = document.getElementById('ical-url').value.trim();
            if (!url) {
                showError('Inserisci un URL valido');
                return;
            }
            
            setICalStatus('loading', 'Caricamento in corso...');
            
            // Salva preferenza proxy
            const selectedProxy = document.getElementById('cors-proxy').value;
            localStorage.setItem('corsProxy', selectedProxy);
            
            const proxies = [
                { name: 'allorigins.win', url: 'https://api.allorigins.win/raw?url=' },
                { name: 'corsproxy.io', url: 'https://corsproxy.io/?' },
                { name: 'cors-anywhere', url: 'https://cors-anywhere.herokuapp.com/' },
                { name: 'nessun proxy', url: '' }
            ];
            
            // Se l'utente ha selezionato un proxy specifico, provalo prima
            let proxiesToTry = proxies;
            if (selectedProxy) {
                const selectedProxyObj = proxies.find(p => p.url === selectedProxy);
                if (selectedProxyObj) {
                    proxiesToTry = [selectedProxyObj, ...proxies.filter(p => p.url !== selectedProxy)];
                }
            }
            
            for (const proxy of proxiesToTry) {
                try {
                    console.log(`Tentativo con proxy: ${proxy.name}`);
                    const finalUrl = proxy.url + encodeURIComponent(url);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 secondi timeout
                    
                    const response = await fetch(finalUrl, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'text/calendar, text/plain, */*',
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const icsData = await response.text();
                    
                    if (!icsData.includes('BEGIN:VCALENDAR')) {
                        throw new Error('Il contenuto non sembra essere un file iCal valido');
                    }
                    
                    const events = parseICS(icsData);
                    
                    icalDates = events;
                    localStorage.setItem('adminIcalDates', JSON.stringify(icalDates));
                    localStorage.setItem('icalUrl', url);
                    
                    updateCombinedDates();
                    updateStats();
                    updateDisplays();
                    
                    setICalStatus('connected', `‚úì ${events.length} eventi caricati (${proxy.name})`);
                    console.log(`Successo con proxy: ${proxy.name}`);
                    return; // Successo! Esci dalla funzione
                    
                } catch (error) {
                    console.error(`Errore con proxy ${proxy.name}:`, error.message);
                    continue; // Prova il prossimo proxy
                }
            }
            
            // Se arriviamo qui, tutti i proxy sono falliti
            setICalStatus('disconnected', 'Errore: tutti i proxy hanno fallito');
            showError('Impossibile caricare il calendario. Verifica l\\'URL e riprova.');
        }
        
        function syncICalData() {
            const url = document.getElementById('ical-url').value.trim();
            if (!url) {
                showError('Inserisci un URL prima di attivare la sincronizzazione');
                return;
            }
            
            loadICalData();
            
            if (icalSyncInterval) {
                clearInterval(icalSyncInterval);
            }
            
            icalSyncInterval = setInterval(() => {
                loadICalData();
            }, 30 * 60 * 1000);
            
            alert('Sincronizzazione automatica attivata (ogni 30 minuti)');
        }
        
        function clearICalData() {
            if (icalSyncInterval) {
                clearInterval(icalSyncInterval);
                icalSyncInterval = null;
            }
            
            icalDates = [];
            localStorage.removeItem('adminIcalDates');
            localStorage.removeItem('icalUrl');
            document.getElementById('ical-url').value = '';
            
            updateCombinedDates();
            updateStats();
            updateDisplays();
            setICalStatus('disconnected', 'Non connesso');
        }
        
        function addManualDate() {
            const dateInput = document.getElementById('manual-date').value;
            const description = document.getElementById('manual-description').value;
            
            if (!dateInput) {
                alert('Seleziona una data');
                return;
            }
            
            if (manualDates.includes(dateInput)) {
                alert('Questa data √® gi√† presente');
                return;
            }
            
            manualDates.push(dateInput);
            localStorage.setItem('adminManualDates', JSON.stringify(manualDates));
            
            updateCombinedDates();
            updateStats();
            updateDisplays();
            
            document.getElementById('manual-date').value = '';
            document.getElementById('manual-description').value = '';
        }
        
        function clearAllManualDates() {
            if (confirm('Sei sicuro di voler cancellare tutte le date manuali?')) {
                manualDates = [];
                localStorage.setItem('adminManualDates', JSON.stringify(manualDates));
                updateCombinedDates();
                updateStats();
                updateDisplays();
            }
        }
        
        function updateStats() {
            document.getElementById('total-occupied').textContent = occupiedDates.length;
            document.getElementById('ical-count').textContent = icalDates.length;
            document.getElementById('bookings-count').textContent = bookings.length;
        }
        
        function updateDisplays() {
            updateBookingsDisplay();
            updateDatesDisplay();
        }
        
        function updateBookingsDisplay() {
            const container = document.getElementById('bookings-list');
            
            if (bookings.length === 0) {
                container.innerHTML = '<p>Nessuna prenotazione ricevuta</p>';
                return;
            }
            
            container.innerHTML = '';
            bookings.reverse().forEach((booking, index) => {
                const bookingElement = document.createElement('div');
                bookingElement.className = 'booking-item';
                bookingElement.innerHTML = `
                    <h4>${booking.firstName} ${booking.lastName}</h4>
                    <p><strong>üìÖ</strong> ${booking.checkIn} ‚Üí ${booking.checkOut} (${booking.nights} notti)</p>
                    <p><strong>üí∞</strong> ‚Ç¨${booking.totalPrice} - <strong>üë•</strong> ${booking.guests} ospiti</p>
                    <p><strong>üìû</strong> ${booking.phone} - <strong>üìß</strong> ${booking.email}</p>
                    <p><strong>‚è∞</strong> ${new Date(booking.timestamp).toLocaleString('it-IT')}</p>
                `;
                container.appendChild(bookingElement);
            });
        }
        
        function updateDatesDisplay() {
            const container = document.getElementById('dates-container');
            
            if (occupiedDates.length === 0) {
                container.innerHTML = '<p>Nessuna data occupata</p>';
                return;
            }
            
            container.innerHTML = '';
            const sortedDates = [...occupiedDates].sort();
            
            sortedDates.forEach(date => {
                const dateElement = document.createElement('div');
                const isIcal = icalDates.includes(date);
                dateElement.className = `date-item ${isIcal ? 'ical' : 'manual'}`;
                dateElement.innerHTML = `
                    <div>${formatDateString(date)}</div>
                    <div class="source">${isIcal ? 'iCal' : 'Manuale'}</div>
                    ${!isIcal ? `<button class="delete-btn" onclick="removeManualDate('${date}')">√ó</button>` : ''}
                `;
                container.appendChild(dateElement);
            });
        }
        
        function removeManualDate(date) {
            manualDates = manualDates.filter(d => d !== date);
            localStorage.setItem('adminManualDates', JSON.stringify(manualDates));
            updateCombinedDates();
            updateStats();
            updateDisplays();
        }
        
        function formatDateString(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('it-IT', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function setICalStatus(status, message) {
            const indicator = document.getElementById('ical-status');
            const text = document.getElementById('ical-status-text');
            
            indicator.className = 'status-indicator status-' + status;
            text.textContent = message;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('ical-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }
        
        function exportBookings() {
            if (bookings.length === 0) {
                alert('Nessuna prenotazione da esportare');
                return;
            }
            
            const csvContent = 'Nome,Cognome,Telefono,Email,Check-in,Check-out,Notti,Ospiti,Totale,Data Prenotazione\n' +
                bookings.map(b => 
                    `${b.firstName},${b.lastName},${b.phone},${b.email},${b.checkIn},${b.checkOut},${b.nights},${b.guests},‚Ç¨${b.totalPrice},${new Date(b.timestamp).toLocaleString('it-IT')}`
                ).join('\n');
                
            downloadCSV('prenotazioni.csv', csvContent);
        }
        
        function exportDates() {
            if (occupiedDates.length === 0) {
                alert('Nessuna data da esportare');
                return;
            }
            
            const csvContent = 'Data,Fonte\n' +
                occupiedDates.map(date => 
                    `${date},${icalDates.includes(date) ? 'iCal' : 'Manuale'}`
                ).join('\n');
                
            downloadCSV('date_occupate.csv', csvContent);
        }
        
        function downloadCSV(filename, content) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportAllData() {
            const allData = {
                manualDates: manualDates,
                icalDates: icalDates,
                bookings: bookings,
                pricing: JSON.parse(localStorage.getItem('adminPricing') || '{}'),
                icalUrl: localStorage.getItem('icalUrl'),
                corsProxy: localStorage.getItem('corsProxy'),
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'backup_completo.json';
            link.click();
        }
        
        function importData() {
            document.getElementById('import-file').click();
        }
        
        function handleImport() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.manualDates) manualDates = data.manualDates;
                    if (data.icalDates) icalDates = data.icalDates;
                    if (data.bookings) bookings = data.bookings;
                    if (data.icalUrl) document.getElementById('ical-url').value = data.icalUrl;
                    if (data.corsProxy) document.getElementById('cors-proxy').value = data.corsProxy;
                    
                    // Salva tutto
                    localStorage.setItem('adminManualDates', JSON.stringify(manualDates));
                    localStorage.setItem('adminIcalDates', JSON.stringify(icalDates));
                    localStorage.setItem('adminBookings', JSON.stringify(bookings));
                    if (data.icalUrl) localStorage.setItem('icalUrl', data.icalUrl);
                    if (data.corsProxy) localStorage.setItem('corsProxy', data.corsProxy);
                    if (data.pricing) localStorage.setItem('adminPricing', JSON.stringify(data.pricing));
                    
                    updateCombinedDates();
                    updateStats();
                    updateDisplays();
                    if (data.pricing) loadPricing();
                    
                    alert('Dati importati con successo!');
                    
                } catch (error) {
                    alert('Errore nell\'importazione: file non valido');
                }
            };
            reader.readAsText(file);
        }
        
        function clearAllBookings() {
            if (confirm('Sei sicuro di voler cancellare tutte le prenotazioni?')) {
                bookings = [];
                localStorage.setItem('adminBookings', JSON.stringify(bookings));
                updateStats();
                updateDisplays();
            }
        }
        
        function resetAllData() {
            if (confirm('ATTENZIONE: Questo canceller√† TUTTI i dati (prenotazioni, date, prezzi). Sei sicuro?')) {
                localStorage.clear();
                manualDates = [];
                icalDates = [];
                bookings = [];
                occupiedDates = [];
                
                if (icalSyncInterval) {
                    clearInterval(icalSyncInterval);
                }
                
                document.getElementById('ical-url').value = '';
                document.getElementById('cors-proxy').value = 'https://api.allorigins.win/raw?url=';
                document.getElementById('price-low').value = 80;
                document.getElementById('price-medium').value = 120;
                document.getElementById('price-high').value = 180;
                document.getElementById('price-holiday').value = 150;
                
                updateStats();
                updateDisplays();
                setICalStatus('disconnected', 'Non connesso');
                
                alert('Tutti i dati sono stati cancellati');
            }
        }
        
        // Auto-refresh delle prenotazioni ogni 30 secondi
        setInterval(() => {
            const savedBookings = localStorage.getItem('adminBookings');
            if (savedBookings) {
                const newBookings = JSON.parse(savedBookings);
                if (newBookings.length !== bookings.length) {
                    bookings = newBookings;
                    updateStats();
                    updateDisplays();
                }
            }
        }, 30000);
    </script>
</body>
</html>