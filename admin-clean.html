<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† Pannello Admin - Gestione Prenotazioni</title>
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=Baw-8C5CCEaLQSaIj7EY26d2v-gLH6et3Nx75-X9fnSd5PPvGnAlT2PkT1IPVsEsEpx7rYxJK_N8gIegpTklIdB9w-NAWfN24bkxmtm_gfYsMBjgoI92e4Rf1Tye8dAZYMOqnV4qpuC4lZFhOYbxWm7J4aD37VTw1W0i8gVSgFkB2mjxGjSX_XHgR_ZDuuEvRqtcAnwXXLdmryetvnw2TJ-37dmaideXHo4A-ZTrmXE8ptmlkSqpmq96cACk3ZGSCZ1JeUlQzaq_Z6DSSWovfguNje0Bok8xBxXlLFCee2weZ9ME81LSD0lmqtWI_nA6AWVnOQpVvPvk47GZK_jAVx1YgvHtJnvR-njLtbkk5T13fGZFiOF9q4wc8YsGph4L9Urnbm3ONYzZRE6L3Ydb7ZaTmVq13PfHVWYMMJmpNzuhBbX7t2TG4NswFj8MfgxMPjfOeCNaJpJO_DAXY4YxbUCbu0LlE8JOqKnXF9ZfpKZL9cewot5gWEi33YyVgs5IbWap9FYxASSVEpbPqUwzuyrkNGJTYqAvyCh6szOHAgbXfdDcFeTWOkKh3eYaxtf3lvw60M6ukFjqSsbC-ohqn1OwrMH-b47Wg7lZwrzPb2lBPDhK3WziB7omxDi3BBJJAFskY1I5o5-em8zqk5odkkmXTvteSpKxbcqxDlIkIr2l4EizPOhnmOaIN7VjNyDVvyQWLlMLSzrXBy5jBgx0QQODNtDkoIIfFc2i3HMbrAAQ6QNFcf2WRoycSEBi9ObWMngK7XvKNh0XLDakZVUi2XwXPNRXAGoaEVesb9SoTOU__zip07HIT3k9Vv1iSFMof13bPnC2fSmyA0qht0m_Fc9ZxE4G2d9bkzRxa-h94wpV6Evct-iXJyXCUcWg4Cd0YvxqGq1Otz5HGIseuJ5IUZv41lbXoB8lbXe4v8ntOfao2E6eB9QfYKyo4_qLxkZEIq1G_Eh0F4lDnfH_auuSbbt6ABWVwYCfNkavyOski-w-I9_baNEZxi7Nj4eLvXnzmeysdLNiLpEUrlow9Aw8p92tVnldFOSAEOOZ7J25sXrZUlK5TStxMIpJ8wak0ke14vWcO7FJ346j8xUQtnlSd9Tkyhdyt-MK6yCtHp_gD7t5wCpsFgoIvO-10yeqRqJsllytNDxXI2zwmLVbCluooUx-jDPnZQwlJdSRAmGYP_XSa1UjtqZaiph0gnIydVfur6Dkytqut_YKQhztQWtpEQfBG7zMv-_INwG2rICug6K_zunGAKwTjeG3mdG8pqqTWxJ6690g_wZtH0FEWPETVOLi1xj5yvPWn3jvCY6CsSp9JktY85oj8ubd-ZvDT60TzXSnTMEis7IbwcRLlihVAM_13wgSKrXr82OJfc72VfQnDa-SDS83X0LBaEIiXJ4bAvCqN6qxwHYjpeQEvQPQq-b59RpKB9JtN3Y-AahAMw0QABlNxBIQJlDQGzy5yiK238Qv62c-vleGKhZ-2KrVimmIWZFYT0BoNzSubAYknfMQMesU5bkwfv451KXFsv1lDhGvgDT81gkgU_Zc5nBiVrcdirYHoGCKPhDYfvMJDbSxRKG-R33D1yzys2wMReKMnoA1PJqQ0k5Kt8n5K9oBugZUqDoifPQQitJEuiRaFJ_jQx1DDHXT1rs_P1ZtVrkCMHAR9DqYFGx5jQ-fdzhMhVolMkKVwo0aQCV6LGkcy0dX4TFeYQC3Qxx1-n8xCh_TQWO4_qtfwnKS9pW1NrmebKFTFuQIIAbwHNGWE7EHQjt5PagJhJ9dxj5jclyQpClc2a027ek9_n-qdfWT8xu5687FG7pkvhe3iDxyZ0F8AvMbDPaBCfMWZuwx_KI9dxKKTKMLAaHAx1n7vTNrj0UiFvCePvI56oRTtXOcPwxyCsKvvRGO51Ba9gxAXJX8bIzLoCN44viiEOhyoc4TJNldAPwZr-RPrJHskB6dGzFPmC91knlrq7PtmMa9LYxneYpMrAzV8qUteERmQtx44KhAPwqNlWv_MVhlBtwSHBkEx6lTRJ7qHnMaxcwkuR0ELg-l0CTNJXRbXwdQSIA9uMtu4_vwyGLPwwO3E5oDCAgkEHEBdUWx3hdht_ArOK5f8W2IM2c0GU1Q9RJMUnnXUupmaMQ8SBcLmMKqNM2u6E0w2k3C5sX8ZxfedBxoDkOYmeOJJzuMdCjPkkrR5GDDXbn2SoohYFRpjZtkeeXuYUriRZpTTxbHISvRirBuMh7_tVyJVWnLdkhTD6kRT3Jqk-6qSHl67LA7gOvLbFfewX4wSnA" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="https://gc.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9wcGwtYWktY29kZS1pbnRlcnByZXRlci1maWxlcy5zMy5hbWF6b25hd3MuY29tL3dlYi9kaXJlY3QtZmlsZXMvNmFjNDFhYWQ1NTU1NDVhNjg5YTg4NjliNjhhOGY2MGEvOWYwYTljNmYtMzc0My00ODhiLWJhYjktZTFjMTU4N2ExMTFkL2JjNGExMzEwLmh0bWw_cmVzcG9uc2UtY29udGVudC1kaXNwb3NpdGlvbj1hdHRhY2htZW50JTNiJTIwZmlsZW5hbWUlM2RhZG1pbi1jbGVhbi5odG1sJTNiJTIwZmlsZW5hbWUlMmElM2RVVEYtOCUyNyUyN2FkbWluLWNsZWFuLmh0bWwmQVdTQWNjZXNzS2V5SWQ9QVNJQTJGM0VNRVlFUUpEM0M0RU4mU2lnbmF0dXJlPXNGamZvQzUxR0hBMEpPR3RKbTl2ZWRMJTJmY3VvJTNkJngtYW16LXNlY3VyaXR5LXRva2VuPUlRb0piM0pwWjJsdVgyVmpFTkwlMmYlMmYlMmYlMmYlMmYlMmYlMmYlMmYlMmYlMmZ3RWFDWFZ6TFdWaGMzUXRNU0pJTUVZQ0lRQ085MTg3a0FUazJjWUhQUndrT1U2OHNWNTJSNzAlMmYzek1RRUs4akxNbTkzd0loQUxOUEs3SGN5VWxQN0ExREc5djNvYlRNTiUyZjgyQnY3ZkVDaGlMRGFmMkZtUkt2RUVDSG9RQVJvTU5qazVOelV6TXpBNU56QTFJZ3lHdHoyRnFDbGs1VUpNcFBzcXpnUW5LRTBINGhNQk1xQW9HeVFvOXklMmJxbWJ4enoyNXA5ZXM4MmR1SENKQWFUUXhlNmRhNGdwNTV6SGZYTTM3cUtZdkh4THRWWTl6cDJXcnMwJTJmT0lpb2ZPUXR0TlZWV1pqRXBRc01JekMyM1pvY3NuZ1ZBV3o1VTRWdmJubkZvb08yVzJQU3ZIckdoRWZTMlo1WDFkbENKeldSZjdjYnZjQ3RFd0ExMG5LJTJiVkI4QzdhOSUyZiUyZlFzV2RlTiUyYk1PR2NaT0o3S3BnVlF4Z2pHeGRyUDFvMzdsbVZrMko4TnhyMldLZk1odjBSRk9EVkdhU09lbTVFSzdqSSUyYjNCeUhaVEV3bjRPVm4ydEVEMVNOZkxNd3ZpMk4lMmIzVjY0cWglMmZIdyUyYm84Sm9Nd1VOaSUyZnFtWGxBekFKbDNpJTJiVWwxVE40eThrMkFPVHBBSDVBZEE1RU5CTWpIdUloWXloczdBb0VUS0JscWtEVGxzJTJmOE1QQnQlMmY1TWV2V2dLN1J2S3c5T3lDN3k4VExHblJxJTJiMUl2Qkg0V3RuY0NmaFBIR2FHZ3RFZ2xHMndGOUVDV3FvQmx5UG5VdkNVd2lXYUZFSDdrYnZxQkdlUVIwU0JFMW85d3YxbURZT3RVZzNFemNlVm84UGtjbFpkZ0huTUExTEx1dW50eE5CR1ROdkh4MWJHN3Z1bUw3SzU3JTJiWjI4aVBzbEZtSXIlMmJPcTlsJTJmZXVFZDlaYnZHbm1yOGVDR0Y5SjFzJTJiTWZVSiUyYlBtQVJQOUxGWVdKcW85aWpYancxWEU1RDNTaVJuaEhESFh5c0JVdWpnJTJmU2syVGRYS3JubG9rU01Xa1klMmY1RHN5JTJicFlneDZsdlB2dElCcXUyQ1dLSEZkblIxUEFHcTIzRWRtNXNaMDRtMFBXWnY2YXNvem5UT1JZMVpjRHlwaEx6cVJHTEVtaU05enBzVHZ2Y2JoVnhjb0tOaVoxWlZSJTJmZXRGZSUyZnYwRG5VekNEUURRUWNzWnBmOGpQUkVjVzdLJTJiM0R2S2xwaHRBREJwbjglMmYlMmZhZjc0M2F2dnljZ3BvTGlyaGU3ejNFUEwzRERBcjclMmZIQmpxWkFaTXFKdDI5JTJmQXRwbWZjSnNwR3FiRmQ1c0lGZHVnZVVvWVB5WkZIN1NoV2tkN0k3NlZueWNzZmF0MlZDOGl5Wlg3NlpucnpQc2NSajdJa2J6em15aTZQY2NsdXNrUmdoWGd3aVdzMTFvTEt6TWxoMHA0cldzVzBVSyUyYlB6ajRrSmlKVkNRUmsxQVNHZmRpN0klMmZ2YURpcW5JbmpZYzdvSHN2V3FLYnU4MUFZUlUlMmIxYVlZVzdyVEJNWm5nb1QydWNmYWhBemNEUyUyYlBJVVJHdyUzZCUzZCZFeHBpcmVzPTE3NjA1NDk0Mzc"/><style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #7f8c8d;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #3498db;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .stat-card.ical h3 {
            color: #e74c3c;
        }
        
        .stat-card.bookings h3 {
            color: #2ecc71;
        }
        
        .ical-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .ical-section h3 {
            color: white;
            margin-bottom: 20px;
        }
        
        .ical-section .form-group input {
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background-color: #2ecc71; }
        .status-disconnected { background-color: #e74c3c; }
        .status-loading { 
            background-color: #f39c12; 
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .error-message {
            background-color: rgba(231,76,60,0.1);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .price-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .price-item input {
            width: 80px;
            text-align: right;
        }
        
        .bookings-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .booking-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #2ecc71;
        }
        
        .booking-item h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .booking-item p {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 3px;
        }
        
        .dates-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .date-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            position: relative;
        }
        
        .date-item.ical {
            border-left-color: #e74c3c;
        }
        
        .date-item .source {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }

        .proxy-options {
            margin-top: 15px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .proxy-options select {
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 12px;
            padding: 5px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Pannello Admin - Gestione Prenotazioni</h1>
            <p>Gestisci calendari, prezzi e prenotazioni</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <h3 id="total-occupied">0</h3>
                <p>Date Occupate Totali</p>
            </div>
            <div class="stat-card ical">
                <h3 id="ical-count">0</h3>
                <p>Da Calendario iCal</p>
            </div>
            <div class="stat-card bookings">
                <h3 id="bookings-count">0</h3>
                <p>Prenotazioni Ricevute</p>
            </div>
        </div>
        
        <!-- Sezione iCal -->
        <div class="ical-section">
            <h3>üîó Sincronizzazione Calendario iCal</h3>
            <div class="form-group">
                <label for="ical-url">URL del calendario iCal (.ics):</label>
                <input type="url" id="ical-url" placeholder="https://calendar.google.com/calendar/ical/esempio.ics">
            </div>
            <button class="btn" onclick="loadICalData()">Carica Calendario</button>
            <button class="btn btn-success" onclick="syncICalData()">Sincronizza Automaticamente</button>
            <button class="btn" onclick="clearICalData()">Rimuovi Sync</button>
            
            <div class="proxy-options">
                <label>Proxy CORS:</label>
                <select id="cors-proxy">
                    <option value="https://api.allorigins.win/raw?url=">allorigins.win (default)</option>
                    <option value="https://corsproxy.io/?">corsproxy.io</option>
                    <option value="https://cors-anywhere.herokuapp.com/">cors-anywhere.herokuapp.com</option>
                    <option value="">Nessun proxy (solo se il server supporta CORS)</option>
                </select>
            </div>
            
            <div style="margin-top: 15px;">
                <span class="status-indicator" id="ical-status"></span>
                <span id="ical-status-text" style="color: white;">Non connesso</span>
            </div>
            
            <div class="error-message" id="ical-error"></div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h2>üìÖ Gestione Date Manuali</h2>
                <div class="form-group">
                    <label for="manual-date">Aggiungi Data Occupata:</label>
                    <input type="date" id="manual-date">
                </div>
                <div class="form-group">
                    <label for="manual-description">Descrizione (opzionale):</label>
                    <input type="text" id="manual-description" placeholder="Es: Prenotazione diretta">
                </div>
                <button class="btn btn-success" onclick="addManualDate()">Aggiungi Data</button>
                <button class="btn btn-danger" onclick="clearAllManualDates()">Cancella Tutte</button>
            </div>
            
            <div class="card">
                <h2>üí∞ Gestione Prezzi</h2>
                <div class="pricing-grid">
                    <div class="price-item">
                        <h4>üå∏ Bassa Stagione</h4>
                        <div class="form-group">
                            <input type="number" id="price-low" value="80" min="0">
                            <span>‚Ç¨/notte</span>
                        </div>
                    </div>
                    <div class="price-item">
                        <h4>‚òÄÔ∏è Media Stagione</h4>
                        <div class="form-group">
                            <input type="number" id="price-medium" value="120" min="0">
                            <span>‚Ç¨/notte</span>
                        </div>
                    </div>
                    <div class="price-item">
                        <h4>üèñÔ∏è Alta Stagione</h4>
                        <div class="form-group">
                            <input type="number" id="price-high" value="180" min="0">
                            <span>‚Ç¨/notte</span>
                        </div>
                    </div>
                    <div class="price-item">
                        <h4>üéÑ Festivit√†</h4>
                        <div class="form-group">
                            <input type="number" id="price-holiday" value="150" min="0">
                            <span>‚Ç¨/notte</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="savePricing()">Salva Prezzi</button>
            </div>
        </div>
        
        <div class="grid">
            <div class="card">
                <h2>üìã Prenotazioni Ricevute</h2>
                <div class="bookings-list" id="bookings-list">
                    <p>Nessuna prenotazione ricevuta</p>
                </div>
                <button class="btn" onclick="exportBookings()">Esporta Prenotazioni</button>
                <button class="btn btn-danger" onclick="clearAllBookings()">Cancella Tutte</button>
            </div>
            
            <div class="card">
                <h2>üóìÔ∏è Date Occupate</h2>
                <div class="dates-container" id="dates-container">
                    <p>Nessuna data occupata</p>
                </div>
                <button class="btn" onclick="exportDates()">Esporta Date</button>
            </div>
        </div>
        
        <div class="card full-width">
            <h2>‚öôÔ∏è Azioni di Sistema</h2>
            <button class="btn" onclick="exportAllData()">üìÑ Esporta Tutti i Dati</button>
            <button class="btn" onclick="importData()">üìÇ Importa Dati</button>
            <input type="file" id="import-file" accept=".json,.ics" style="display: none;" onchange="handleImport()">
            <button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è Reset Completo</button>
        </div>
    </div>

    <script>
        let occupiedDates = [];
        let icalDates = [];
        let manualDates = [];
        let bookings = [];
        let icalSyncInterval = null;
        
        // Caricamento iniziale
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            updateStats();
            updateDisplays();
        });
        
        function loadAllData() {
            // Carica date manuali
            const savedManualDates = localStorage.getItem('adminManualDates');
            if (savedManualDates) {
                manualDates = JSON.parse(savedManualDates);
            }
            
            // Carica date iCal
            const savedIcalDates = localStorage.getItem('adminIcalDates');
            if (savedIcalDates) {
                icalDates = JSON.parse(savedIcalDates);
            }
            
            // Carica prenotazioni
            const savedBookings = localStorage.getItem('adminBookings');
            if (savedBookings) {
                bookings = JSON.parse(savedBookings);
            }
            
            // Carica URL iCal
            const savedIcalUrl = localStorage.getItem('icalUrl');
            if (savedIcalUrl) {
                document.getElementById('ical-url').value = savedIcalUrl;
            }
            
            // Carica proxy preference
            const savedProxy = localStorage.getItem('corsProxy');
            if (savedProxy) {
                document.getElementById('cors-proxy').value = savedProxy;
            }
            
            // Carica prezzi
            loadPricing();
            
            // Aggiorna array combinato
            updateCombinedDates();
        }
        
        function updateCombinedDates() {
            occupiedDates = [...manualDates, ...icalDates];
            // Salva per il frontend
            localStorage.setItem('adminOccupiedDates', JSON.stringify(occupiedDates));
        }
        
        function loadPricing() {
            const savedPricing = localStorage.getItem('adminPricing');
            if (savedPricing) {
                const pricing = JSON.parse(savedPricing);
                document.getElementById('price-low').value = pricing.low.price;
                document.getElementById('price-medium').value = pricing.medium.price;
                document.getElementById('price-high').value = pricing.high.price;
                document.getElementById('price-holiday').value = pricing.holiday.price;
            }
        }
        
        function savePricing() {
            const pricing = {
                low: { 
                    price: parseInt(document.getElementById('price-low').value),
                    name: 'üå∏ Bassa Stagione', 
                    description: 'Gennaio-Marzo, Novembre-Dicembre' 
                },
                medium: { 
                    price: parseInt(document.getElementById('price-medium').value),
                    name: '‚òÄÔ∏è Media Stagione', 
                    description: 'Aprile-Maggio, Settembre-Ottobre' 
                },
                high: { 
                    price: parseInt(document.getElementById('price-high').value),
                    name: 'üèñÔ∏è Alta Stagione', 
                    description: 'Giugno-Agosto' 
                },
                holiday: { 
                    price: parseInt(document.getElementById('price-holiday').value),
                    name: 'üéÑ Festivit√†', 
                    description: 'Natale, Capodanno, Pasqua' 
                }
            };
            
            localStorage.setItem('adminPricing', JSON.stringify(pricing));
            alert('Prezzi salvati con successo!');
        }
        
        // Gestione iCal con proxy multipli
        function parseICS(icsString) {
            const lines = icsString.split(/\r?\n/);
            const events = [];
            let event = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line === 'BEGIN:VEVENT') {
                    event = {};
                } else if (line === 'END:VEVENT' && event) {
                    if (event.DTSTART) {
                        const startDate = parseICalDate(event.DTSTART);
                        let endDate = startDate;
                        
                        if (event.DTEND) {
                            endDate = parseICalDate(event.DTEND);
                        }
                        
                        let currentDate = new Date(startDate);
                        const finalDate = new Date(endDate);
                        
                        while (currentDate <= finalDate) {
                            events.push(currentDate.toISOString().split('T')[0]);
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                    event = null;
                } else if (event) {
                    const match = /^([A-Z-]+[A-Z])[:;](.*)$/.exec(line);
                    if (match) {
                        const [, key, value] = match;
                        // Rimuovi parametri dalle chiavi (es: DTSTART;VALUE=DATE -> DTSTART)
                        const cleanKey = key.split(';')[0];
                        event[cleanKey] = value;
                    }
                }
            }
            
            return events;
        }
        
        function parseICalDate(icalStr) {
            // Rimuovi parametri VALUE=DATE se presenti
            const dateStr = icalStr.includes(':') ? icalStr.split(':')[1] : icalStr;
            
            if (dateStr.includes('T')) {
                // Data con orario: YYYYMMDDTHHMMSS
                const year = dateStr.substr(0, 4);
                const month = dateStr.substr(4, 2);
                const day = dateStr.substr(6, 2);
                return new Date(year, parseInt(month) - 1, day);
            } else {
                // Solo data: YYYYMMDD
                const year = dateStr.substr(0, 4);
                const month = dateStr.substr(4, 2);
                const day = dateStr.substr(6, 2);
                return new Date(year, parseInt(month) - 1, day);
            }
        }
        
        async function loadICalData() {
            const url = document.getElementById('ical-url').value.trim();
            if (!url) {
                showError('Inserisci un URL valido');
                return;
            }
            
            setICalStatus('loading', 'Caricamento in corso...');
            
            // Salva preferenza proxy
            const selectedProxy = document.getElementById('cors-proxy').value;
            localStorage.setItem('corsProxy', selectedProxy);
            
            const proxies = [
                { name: 'allorigins.win', url: 'https://api.allorigins.win/raw?url=' },
                { name: 'corsproxy.io', url: 'https://corsproxy.io/?' },
                { name: 'cors-anywhere', url: 'https://cors-anywhere.herokuapp.com/' },
                { name: 'nessun proxy', url: '' }
            ];
            
            // Se l'utente ha selezionato un proxy specifico, provalo prima
            let proxiesToTry = proxies;
            if (selectedProxy) {
                const selectedProxyObj = proxies.find(p => p.url === selectedProxy);
                if (selectedProxyObj) {
                    proxiesToTry = [selectedProxyObj, ...proxies.filter(p => p.url !== selectedProxy)];
                }
            }
            
            for (const proxy of proxiesToTry) {
                try {
                    console.log(`Tentativo con proxy: ${proxy.name}`);
                    const finalUrl = proxy.url + encodeURIComponent(url);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 secondi timeout
                    
                    const response = await fetch(finalUrl, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'text/calendar, text/plain, */*',
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const icsData = await response.text();
                    
                    if (!icsData.includes('BEGIN:VCALENDAR')) {
                        throw new Error('Il contenuto non sembra essere un file iCal valido');
                    }
                    
                    const events = parseICS(icsData);
                    
                    icalDates = events;
                    localStorage.setItem('adminIcalDates', JSON.stringify(icalDates));
                    localStorage.setItem('icalUrl', url);
                    
                    updateCombinedDates();
                    updateStats();
                    updateDisplays();
                    
                    setICalStatus('connected', `‚úì ${events.length} eventi caricati (${proxy.name})`);
                    console.log(`Successo con proxy: ${proxy.name}`);
                    return; // Successo! Esci dalla funzione
                    
                } catch (error) {
                    console.error(`Errore con proxy ${proxy.name}:`, error.message);
                    continue; // Prova il prossimo proxy
                }
            }
            
            // Se arriviamo qui, tutti i proxy sono falliti
            setICalStatus('disconnected', 'Errore: tutti i proxy hanno fallito');
            showError('Impossibile caricare il calendario. Verifica l\'URL e riprova.');
        }
        
        function syncICalData() {
            const url = document.getElementById('ical-url').value.trim();
            if (!url) {
                showError('Inserisci un URL prima di attivare la sincronizzazione');
                return;
            }
            
            loadICalData();
            
            if (icalSyncInterval) {
                clearInterval(icalSyncInterval);
            }
            
            icalSyncInterval = setInterval(() => {
                loadICalData();
            }, 30 * 60 * 1000);
            
            alert('Sincronizzazione automatica attivata (ogni 30 minuti)');
        }
        
        function clearICalData() {
            if (icalSyncInterval) {
                clearInterval(icalSyncInterval);
                icalSyncInterval = null;
            }
            
            icalDates = [];
            localStorage.removeItem('adminIcalDates');
            localStorage.removeItem('icalUrl');
            document.getElementById('ical-url').value = '';
            
            updateCombinedDates();
            updateStats();
            updateDisplays();
            setICalStatus('disconnected', 'Non connesso');
        }
        
        function addManualDate() {
            const dateInput = document.getElementById('manual-date').value;
            const description = document.getElementById('manual-description').value;
            
            if (!dateInput) {
                alert('Seleziona una data');
                return;
            }
            
            if (manualDates.includes(dateInput)) {
                alert('Questa data √® gi√† presente');
                return;
            }
            
            manualDates.push(dateInput);
            localStorage.setItem('adminManualDates', JSON.stringify(manualDates));
            
            updateCombinedDates();
            updateStats();
            updateDisplays();
            
            document.getElementById('manual-date').value = '';
            document.getElementById('manual-description').value = '';
        }
        
        function clearAllManualDates() {
            if (confirm('Sei sicuro di voler cancellare tutte le date manuali?')) {
                manualDates = [];
                localStorage.setItem('adminManualDates', JSON.stringify(manualDates));
                updateCombinedDates();
                updateStats();
                updateDisplays();
            }
        }
        
        function updateStats() {
            document.getElementById('total-occupied').textContent = occupiedDates.length;
            document.getElementById('ical-count').textContent = icalDates.length;
            document.getElementById('bookings-count').textContent = bookings.length;
        }
        
        function updateDisplays() {
            updateBookingsDisplay();
            updateDatesDisplay();
        }
        
        function updateBookingsDisplay() {
            const container = document.getElementById('bookings-list');
            
            if (bookings.length === 0) {
                container.innerHTML = '<p>Nessuna prenotazione ricevuta</p>';
                return;
            }
            
            container.innerHTML = '';
            bookings.reverse().forEach((booking, index) => {
                const bookingElement = document.createElement('div');
                bookingElement.className = 'booking-item';
                bookingElement.innerHTML = `
                    <h4>${booking.firstName} ${booking.lastName}</h4>
                    <p><strong>üìÖ</strong> ${booking.checkIn} ‚Üí ${booking.checkOut} (${booking.nights} notti)</p>
                    <p><strong>üí∞</strong> ‚Ç¨${booking.totalPrice} - <strong>üë•</strong> ${booking.guests} ospiti</p>
                    <p><strong>üìû</strong> ${booking.phone} - <strong>üìß</strong> ${booking.email}</p>
                    <p><strong>‚è∞</strong> ${new Date(booking.timestamp).toLocaleString('it-IT')}</p>
                `;
                container.appendChild(bookingElement);
            });
        }
        
        function updateDatesDisplay() {
            const container = document.getElementById('dates-container');
            
            if (occupiedDates.length === 0) {
                container.innerHTML = '<p>Nessuna data occupata</p>';
                return;
            }
            
            container.innerHTML = '';
            const sortedDates = [...occupiedDates].sort();
            
            sortedDates.forEach(date => {
                const dateElement = document.createElement('div');
                const isIcal = icalDates.includes(date);
                dateElement.className = `date-item ${isIcal ? 'ical' : 'manual'}`;
                dateElement.innerHTML = `
                    <div>${formatDateString(date)}</div>
                    <div class="source">${isIcal ? 'iCal' : 'Manuale'}</div>
                    ${!isIcal ? `<button class="delete-btn" onclick="removeManualDate('${date}')">√ó</button>` : ''}
                `;
                container.appendChild(dateElement);
            });
        }
        
        function removeManualDate(date) {
            manualDates = manualDates.filter(d => d !== date);
            localStorage.setItem('adminManualDates', JSON.stringify(manualDates));
            updateCombinedDates();
            updateStats();
            updateDisplays();
        }
        
        function formatDateString(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('it-IT', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function setICalStatus(status, message) {
            const indicator = document.getElementById('ical-status');
            const text = document.getElementById('ical-status-text');
            
            indicator.className = 'status-indicator status-' + status;
            text.textContent = message;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('ical-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }
        
        function exportBookings() {
            if (bookings.length === 0) {
                alert('Nessuna prenotazione da esportare');
                return;
            }
            
            const csvContent = 'Nome,Cognome,Telefono,Email,Check-in,Check-out,Notti,Ospiti,Totale,Data Prenotazione\n' +
                bookings.map(b => 
                    `${b.firstName},${b.lastName},${b.phone},${b.email},${b.checkIn},${b.checkOut},${b.nights},${b.guests},‚Ç¨${b.totalPrice},${new Date(b.timestamp).toLocaleString('it-IT')}`
                ).join('\n');
                
            downloadCSV('prenotazioni.csv', csvContent);
        }
        
        function exportDates() {
            if (occupiedDates.length === 0) {
                alert('Nessuna data da esportare');
                return;
            }
            
            const csvContent = 'Data,Fonte\n' +
                occupiedDates.map(date => 
                    `${date},${icalDates.includes(date) ? 'iCal' : 'Manuale'}`
                ).join('\n');
                
            downloadCSV('date_occupate.csv', csvContent);
        }
        
        function downloadCSV(filename, content) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportAllData() {
            const allData = {
                manualDates: manualDates,
                icalDates: icalDates,
                bookings: bookings,
                pricing: JSON.parse(localStorage.getItem('adminPricing') || '{}'),
                icalUrl: localStorage.getItem('icalUrl'),
                corsProxy: localStorage.getItem('corsProxy'),
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'backup_completo.json';
            link.click();
        }
        
        function importData() {
            document.getElementById('import-file').click();
        }
        
        function handleImport() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.manualDates) manualDates = data.manualDates;
                        if (data.icalDates) icalDates = data.icalDates;
                        if (data.bookings) bookings = data.bookings;
                        if (data.icalUrl) document.getElementById('ical-url').value = data.icalUrl;
                        if (data.corsProxy) document.getElementById('cors-proxy').value = data.corsProxy;
                        
                        // Salva tutto
                        localStorage.setItem('adminManualDates', JSON.stringify(manualDates));
                        localStorage.setItem('adminIcalDates', JSON.stringify(icalDates));
                        localStorage.setItem('adminBookings', JSON.stringify(bookings));
                        if (data.icalUrl) localStorage.setItem('icalUrl', data.icalUrl);
                        if (data.corsProxy) localStorage.setItem('corsProxy', data.corsProxy);
                        if (data.pricing) localStorage.setItem('adminPricing', JSON.stringify(data.pricing));
                        
                        updateCombinedDates();
                        updateStats();
                        updateDisplays();
                        if (data.pricing) loadPricing();
                        
                        alert('Dati importati con successo!');
                        
                    } else if (file.name.endsWith('.ics')) {
                        const icsData = e.target.result;
                        const events = parseICS(icsData);
                        
                        // Aggiungi come date manuali
                        events.forEach(date => {
                            if (!manualDates.includes(date)) {
                                manualDates.push(date);
                            }
                        });
                        
                        localStorage.setItem('adminManualDates', JSON.stringify(manualDates));
                        updateCombinedDates();
                        updateStats();
                        updateDisplays();
                        
                        alert(`File iCS importato: ${events.length} date aggiunte come manuali`);
                    }
                    
                } catch (error) {
                    alert('Errore nell\'importazione: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function clearAllBookings() {
            if (confirm('Sei sicuro di voler cancellare tutte le prenotazioni?')) {
                bookings = [];
                localStorage.setItem('adminBookings', JSON.stringify(bookings));
                updateStats();
                updateDisplays();
            }
        }
        
        function resetAllData() {
            if (confirm('ATTENZIONE: Questo canceller√† TUTTI i dati (prenotazioni, date, prezzi). Sei sicuro?')) {
                localStorage.clear();
                manualDates = [];
                icalDates = [];
                bookings = [];
                occupiedDates = [];
                
                if (icalSyncInterval) {
                    clearInterval(icalSyncInterval);
                }
                
                document.getElementById('ical-url').value = '';
                document.getElementById('cors-proxy').value = 'https://api.allorigins.win/raw?url=';
                document.getElementById('price-low').value = 80;
                document.getElementById('price-medium').value = 120;
                document.getElementById('price-high').value = 180;
                document.getElementById('price-holiday').value = 150;
                
                updateStats();
                updateDisplays();
                setICalStatus('disconnected', 'Non connesso');
                
                alert('Tutti i dati sono stati cancellati');
            }
        }
        
        // Auto-refresh delle prenotazioni ogni 30 secondi
        setInterval(() => {
            const savedBookings = localStorage.getItem('adminBookings');
            if (savedBookings) {
                const newBookings = JSON.parse(savedBookings);
                if (newBookings.length !== bookings.length) {
                    bookings = newBookings;
                    updateStats();
                    updateDisplays();
                }
            }
        }, 30000);
    </script>
</body>
</html>